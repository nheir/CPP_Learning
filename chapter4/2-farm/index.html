<!doctype html><html lang=fr dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 7.0.1+72a875f1db967152c77914cff4d53f8fcee0e619"><meta name=description content="Vous allez maintenant apprendre √† d√©finir des classes permettant √† leurs enfants de sp√©cialiser leur comportement. On parle alors de classe polymorphe.
Nous ferons un petit r√©capitulatif en fin de page, pour rappelez les points essentiels auxquels il faut faire attention lorsque vous d√©finissez des classes polymorphes pour √©viter les bugs.
Pour cet exercice, vous modifierez les fichiers :
- chap-04/2-farm/FarmHouse.cpp
- chap-04/2-farm/Animal.h
- chap-04/2-farm/Dog.h
- chap-04/2-farm/Cat.h
- chap-04/2-farm/Chicken.h
- chap-04/2-farm/Cow."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="üêÆ Concerto animalier :: Cours de C++ - Niveau Master"><meta name=twitter:description content="Vous allez maintenant apprendre √† d√©finir des classes permettant √† leurs enfants de sp√©cialiser leur comportement. On parle alors de classe polymorphe.
Nous ferons un petit r√©capitulatif en fin de page, pour rappelez les points essentiels auxquels il faut faire attention lorsque vous d√©finissez des classes polymorphes pour √©viter les bugs.
Pour cet exercice, vous modifierez les fichiers :
- chap-04/2-farm/FarmHouse.cpp
- chap-04/2-farm/Animal.h
- chap-04/2-farm/Dog.h
- chap-04/2-farm/Cat.h
- chap-04/2-farm/Chicken.h
- chap-04/2-farm/Cow."><meta property="og:url" content="/chapter4/2-farm/index.html"><meta property="og:site_name" content="Cours de C++ - Niveau Master"><meta property="og:title" content="üêÆ Concerto animalier :: Cours de C++ - Niveau Master"><meta property="og:description" content="Vous allez maintenant apprendre √† d√©finir des classes permettant √† leurs enfants de sp√©cialiser leur comportement. On parle alors de classe polymorphe.
Nous ferons un petit r√©capitulatif en fin de page, pour rappelez les points essentiels auxquels il faut faire attention lorsque vous d√©finissez des classes polymorphes pour √©viter les bugs.
Pour cet exercice, vous modifierez les fichiers :
- chap-04/2-farm/FarmHouse.cpp
- chap-04/2-farm/Animal.h
- chap-04/2-farm/Dog.h
- chap-04/2-farm/Cat.h
- chap-04/2-farm/Chicken.h
- chap-04/2-farm/Cow."><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="H√©ritage"><meta itemprop=name content="üêÆ Concerto animalier :: Cours de C++ - Niveau Master"><meta itemprop=description content="Vous allez maintenant apprendre √† d√©finir des classes permettant √† leurs enfants de sp√©cialiser leur comportement. On parle alors de classe polymorphe.
Nous ferons un petit r√©capitulatif en fin de page, pour rappelez les points essentiels auxquels il faut faire attention lorsque vous d√©finissez des classes polymorphes pour √©viter les bugs.
Pour cet exercice, vous modifierez les fichiers :
- chap-04/2-farm/FarmHouse.cpp
- chap-04/2-farm/Animal.h
- chap-04/2-farm/Dog.h
- chap-04/2-farm/Cat.h
- chap-04/2-farm/Chicken.h
- chap-04/2-farm/Cow."><meta itemprop=wordCount content="2461"><title>üêÆ Concerto animalier :: Cours de C++ - Niveau Master</title>
<link href=../../css/fontawesome-all.min.css?1729268528 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/fontawesome-all.min.css?1729268528 rel=stylesheet></noscript><link href=../../css/nucleus.css?1729268528 rel=stylesheet><link href=../../css/auto-complete.css?1729268528 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/auto-complete.css?1729268528 rel=stylesheet></noscript><link href=../../css/perfect-scrollbar.min.css?1729268528 rel=stylesheet><link href=../../css/fonts.css?1729268528 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/fonts.css?1729268528 rel=stylesheet></noscript><link href=../../css/theme.css?1729268528 rel=stylesheet><link href=../../css/theme-mine.css?1729268528 rel=stylesheet id=R-variant-style><link href=../../css/chroma-relearn-light.css?1729268528 rel=stylesheet id=R-variant-chroma-style><link href=../../css/print.css?1729268528 rel=stylesheet media=print><script src=../../js/variant.js?1729268528></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.variants&&variants.init(["mine"]),window.T_Copy_to_clipboard=`Copier dans le presse-papiers`,window.T_Copied_to_clipboard=`Copi√© dans le presse-papiers!`,window.T_Copy_link_to_clipboard=`Copier le lien dans le presse-papiers`,window.T_Link_copied_to_clipboard=`Lien copi√© dans le presse-papiers!`,window.T_Reset_view=`R√©initialiser la vue`,window.T_View_reset=`Vue r√©initialis√©e!`,window.T_No_results_found=`Aucun r√©sultat trouv√© pour "{0}"`,window.T_N_results_found=`{1} r√©sultats trouv√©s pour "{0}"`</script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=../../chapter4/2-farm/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table des mati√®res (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><ul><li><a href=#fonction-virtuelle>Fonction virtuelle</a></li><li><a href=#v√©rification-de-la-signature>V√©rification de la signature</a></li><li><a href=#conteneurs-polymorphes>Conteneurs polymorphes</a></li><li><a href=#destructeurs-virtuels>Destructeurs virtuels</a></li><li><a href=#ce-quil-faut-retenir>Ce qu&rsquo;il faut retenir</a></li></ul></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../index.html><span itemprop=name>Accueil</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../chapter4/index.html><span itemprop=name>H√©ritage</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>üêÆ Concerto animalier</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../../chapter4/1-hierarchy/index.html title="üíº Hi√©rarchie professionnelle (ü°ê)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../../chapter4/3-virtual/index.html title="R√©solution d'appel virtuel (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Aller plus loin"><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter4" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=-concerto-animalier>üêÆ Concerto animalier</h1><p>Vous allez maintenant apprendre √† d√©finir des classes permettant √† leurs enfants de sp√©cialiser leur comportement. On parle alors de <strong>classe polymorphe</strong>.<br>Nous ferons un petit r√©capitulatif en fin de page, pour rappelez les points essentiels auxquels il faut faire attention lorsque vous d√©finissez des classes polymorphes pour √©viter les bugs.</p><hr><p>Pour cet exercice, vous modifierez les fichiers :<br>- <code>chap-04/2-farm/FarmHouse.cpp</code><br>- <code>chap-04/2-farm/Animal.h</code><br>- <code>chap-04/2-farm/Dog.h</code><br>- <code>chap-04/2-farm/Cat.h</code><br>- <code>chap-04/2-farm/Chicken.h</code><br>- <code>chap-04/2-farm/Cow.h</code></p><p>La cible √† compiler est <code>c4-2-farm</code>.</p><hr><h3 id=fonction-virtuelle>Fonction virtuelle</h3><p>Essayez de compiler le programme fourni.
Vous devriez avoir une erreur au niveau de l&rsquo;appel √† <code>sing_a_lot</code> dans le <code>main</code>, vous indiquant qu&rsquo;il n&rsquo;est pas possible de convertir les diff√©rentes classes <code>Dog</code>, <code>Cat</code>, <code>Cow</code> et <code>Chicken</code> en <code>Animal</code>.<br>Selon vous, que faut-il faire dans chacune de ces classes pour que l&rsquo;on puisse passer une variable de ce type √† une fonction attendant une r√©f√©rence sur un <code>Animal</code> ?<br>Modifiez le programme en cons√©quence pour qu&rsquo;il compile.</p><div class=expand><input type=checkbox id=R-expand-be455ca3ccbfa125a736fe15f5ac20e8 aria-controls=R-expandcontent-be455ca3ccbfa125a736fe15f5ac20e8>
<label class=expand-label for=R-expand-be455ca3ccbfa125a736fe15f5ac20e8><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-be455ca3ccbfa125a736fe15f5ac20e8 class=expand-content><p>Il faut que chacune de ces classes h√©rite de <code>Animal</code>. Et comme sp√©cifi√© pr√©c√©demment, on n&rsquo;oublie pas d&rsquo;indiquer le mot-clef <code>public</code> dans la relation de parent√©.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Cat</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Animal</span> <span class=p>{</span> <span class=p>...</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Chicken</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Animal</span> <span class=p>{</span> <span class=p>...</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Cow</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Animal</span> <span class=p>{</span> <span class=p>...</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dog</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Animal</span> <span class=p>{</span> <span class=p>...</span> <span class=p>};</span></span></span></code></pre></div></div></div><p>Essayez maintenant d&rsquo;ex√©cuter le programme. Comme vous pouvez le constater, c&rsquo;est la fonction <code>sing</code> de la classe <code>Animal</code> qui est appel√©e √† chaque fois, et non pas les fonctions <code>sing</code> de chacune des sous-classes.</p><p>Pour demander au compilateur d&rsquo;appeler les impl√©mentations sp√©cifi√©es dans les classes d√©riv√©es plut√¥t que celle de la classe de base, vous allez devoir rendre la fonction <code>sing</code> <strong>virtuelle</strong>.
Pour ce faire, il faut placer le mot-clef <code>virtual</code> devant le prototype de la fonction dans <code>Animal</code> :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Animal</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=kt>void</span> <span class=n>sing</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;...&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>Recompilez √† nouveau le programme. Les impl√©mentations dans les classes d√©riv√©es devraient maintenant √™tre appel√©es.</p><hr><h3 id=v√©rification-de-la-signature>V√©rification de la signature</h3><p>Vous aimeriez maintenant rajouter un param√®tre √† la fonction, permettant de remplacer le retour √† la ligne par un espace :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Meow Meow
</span></span><span class=line><span class=cl>Waf
</span></span><span class=line><span class=cl>Mewwwwwh Mewwwwwh Mewwwwwh
</span></span><span class=line><span class=cl>Waf
</span></span><span class=line><span class=cl>Cotcotcotcodet Cotcotcotcodet</span></span></code></pre></div><p>R√©alisez les modifications dans le programme pour obtenir la sortie ci-dessus. N√©anmoins, comme vous n&rsquo;avez pas pris votre caf√© ce matin, et vous allez (in)volontairement oublier de modifier le contenu de Cow.h.</p><div class=expand><input type=checkbox id=R-expand-55cbd668f237cdd6617d915c84b71ec6 aria-controls=R-expandcontent-55cbd668f237cdd6617d915c84b71ec6>
<label class=expand-label for=R-expand-55cbd668f237cdd6617d915c84b71ec6><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-55cbd668f237cdd6617d915c84b71ec6 class=expand-content><p>Animal.h :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>virtual</span> <span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;...&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span></span></span></code></pre></div><p>Classes d√©riv√©es (sauf <code>Cow</code>) :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;&lt;some noise&gt;&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span></span></span></code></pre></div><p>FarmHouse.cpp:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing_a_lot</span><span class=p>(</span><span class=k>const</span> <span class=n>Animal</span><span class=o>&amp;</span> <span class=n>animal</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>times</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>times</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=o>--</span><span class=n>times</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>animal</span><span class=p>.</span><span class=n>sing</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>animal</span><span class=p>.</span><span class=n>sing</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><p>Vous devriez constater que malgr√© votre √©tourderie, le programme compile toujours. Cependant, c&rsquo;est de nouveau l&rsquo;impl√©mentation de <code>sing</code> dans <code>Animal</code> qui est appel√©e, plut√¥t que celle de <code>Cow</code>.</p><p>Ce comportement est tout √† fait normal.
Lorsqu&rsquo;une fonction virtuelle <code>fcn</code> est appel√©e sur une classe <code>Class</code>, le programme va d√©terminer quelle fonction appeler en recherchant dans les enfants de <code>Class</code> une fonction ayant la m√™me signature (nom + param√®tres + type de retour + constness) que <code>Class::fcn</code>. Il parcourt donc chacune des classes, de la plus d√©riv√©e √† la moins d√©riv√©e, jusqu&rsquo;√† trouver la d√©claration d&rsquo;une fonction satisfaisant cette condition.</p><p>Comme <code>Cow::sing</code> n&rsquo;a pas la m√™me signature que <code>Animal::sing</code>, et qu&rsquo;il n&rsquo;y a pas d&rsquo;autres surcharges √† <code>sing</code> dans la classe <code>Cow</code>, le programme va remonter dans sa classe parent <code>Animal</code>, et d√©terminer que c&rsquo;est <code>Animal::sing</code> qui doit √™tre utilis√©e.</p><p><strong>C&rsquo;est peut-√™tre normal comme comportement, mais √ßa n&rsquo;emp√™che pas de se retrouver avec des bugs&mldr;</strong></p><p>Lorsque vous modifiez la signature d&rsquo;une fonction virtuelle et que vous oubliez de modifier la signature d&rsquo;une de ses red√©finitions, vous vous retrouvez avez des bugs qui ne sont pas toujours √©vident √† identifier. Ici, vous n&rsquo;aviez que quelques classes, et un seul niveau d&rsquo;h√©ritage, mais dans un programme plus cons√©quent, ce n&rsquo;est pas rare d&rsquo;avoir une bonne centaine de classes h√©ritant d&rsquo;une m√™me classe-m√®re.</p><p>Donc pour √©viter les √©tourderies, vous allez demander au compilateur de vous pr√©venir en cas de divergences de signatures suite √† la modification d&rsquo;une fonction virtuelle.
Pour cela, √† partir de maintenant et jusqu&rsquo;√† la fin de vos jours, d√®s lors que vous red√©finirez une fonction virtuelle dans une classe fille, vous ajouterez le mot-clef <code>override</code> √† la fin de son prototype.</p><p>Vous aurez donc <code>virtual</code> devant le prototype de la fonction dans la classe-m√®re, et <code>override</code> derri√®re le prototype des fonctions dans la classe-fille :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>virtual</span> <span class=kt>void</span> <span class=nf>fcn</span><span class=p>();</span>   <span class=c1>// This function can be overriden in child classes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>fcn</span><span class=p>()</span> <span class=k>override</span><span class=p>;</span>  <span class=c1>// This function is overriding the implementation of a base class&#39;s virtual function.
</span></span></span></code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Remarque</div><div class=box-content><p>Lorsqu&rsquo;une fonction est marqu√©e <code>override</code>, le compilateur effectue les deux v√©rifications suivantes :<br>- il existe une fonction avec la m√™me signature dans l&rsquo;une des classes parent,<br>- cette fonction est d√©clar√©e virtuelle.</p></div></div><p>Ajoutez le mot-clef <code>override</code> √† la fin du prototype de <code>sing</code> (donc derri√®re le <code>const</code>) dans chacune des classes-fille, et v√©rifier que le compilateur refuse maintenant de compiler la fonction <code>Cow::sing</code>.</p><div class=expand><input type=checkbox id=R-expand-48a340490f6fb48f9e1707e25b6287cf aria-controls=R-expandcontent-48a340490f6fb48f9e1707e25b6287cf>
<label class=expand-label for=R-expand-48a340490f6fb48f9e1707e25b6287cf><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-48a340490f6fb48f9e1707e25b6287cf class=expand-content><p>Cow :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing</span><span class=p>()</span> <span class=k>const</span> <span class=k>override</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Mewwwwwh&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span> <span class=p>}</span></span></span></code></pre></div><p>Autres classes d√©riv√©es :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=k>override</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;&lt;some noise&gt;&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span></span></span></code></pre></div></div></div><p>Modifiez maintenant la signature et l&rsquo;impl√©mentation de <code>Cow::sing</code> de mani√®re √† ce que le programme compile et qu&rsquo;il affiche le r√©sultat attendu.</p><div class=expand><input type=checkbox id=R-expand-77351463fc8d7d3774946b78378b3693 aria-controls=R-expandcontent-77351463fc8d7d3774946b78378b3693>
<label class=expand-label for=R-expand-77351463fc8d7d3774946b78378b3693><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-77351463fc8d7d3774946b78378b3693 class=expand-content><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=k>override</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Mewwwwwh&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span></span></span></code></pre></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Information</div><div class=box-content><p>Les mots-clef <code>virtual</code> et <code>override</code> ne font pas partie de la signature des fonctions-membre.
Donc tout comme <code>static</code>, si vous d√©finissez une fonction-membre <code>fcn</code> en dehors de sa classe <code>Class</code>, vous devrez √©crire <code>void Class::fcn() { ... }</code> et non pas <code>virtual void Class::fcn() { ... }</code> ou <code>void Class::fcn() override { ... }</code>.</p></div></div><hr><h3 id=conteneurs-polymorphes>Conteneurs polymorphes</h3><p>Nous allons maintenant voir comment regrouper un ensemble d&rsquo;animaux dans un conteneur, de fa√ßon √† l&rsquo;envoyer √† une fonction.</p><p>Commencez par instancier un <code>std::vector&lt;Animal></code> et essayez d&rsquo;ins√©rer dedans les variables <code>dog</code> et <code>cat</code>.
Cr√©ez ensuite une fonction <code>sing_chorus</code> prenant ce tableau en param√®tres et dans laquelle vous appelerez <code>sing</code> sur chacun de ces √©l√©ments.
Que pouvez-vous constater en testant le programme ?</p><div class=expand><input type=checkbox id=R-expand-38236a63554e35cfdd7e97d61ee55347 aria-controls=R-expandcontent-38236a63554e35cfdd7e97d61ee55347>
<label class=expand-label for=R-expand-38236a63554e35cfdd7e97d61ee55347><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-38236a63554e35cfdd7e97d61ee55347 class=expand-content><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing_chorus</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;&amp;</span> <span class=n>animals</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>animal</span><span class=p>:</span> <span class=n>animals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>animal</span><span class=p>.</span><span class=n>sing</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;</span> <span class=n>animals</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>dog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>cat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sing_chorus</span><span class=p>(</span><span class=n>animals</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>En testant, on s&rsquo;aper√ßoit que c&rsquo;est de nouveau <code>Animal::sing</code> qui est appel√© et non pas les fonctions d√©riv√©es&mldr;</p></div></div><p><strong>D&rsquo;o√π vient le probl√®me ?</strong></p><p>En fait, en cr√©ant un <code>vector&lt;Animal></code>, chaque fois que vous avez ajout√© un √©l√©ment dans le tableau, vous avez instanci√© un nouvel objet de type <code>Animal</code>.
Comme <code>dog</code> est un <code>Dog</code>, il peut √™tre converti en <code>const Animal&</code>, et donc, le constructeur de copie <code>Animal(const Animal&)</code> est appel√© pour cr√©er chacun des √©l√©ments.
Dans votre tableau, vous avez donc cr√©er des objets de type <code>Animal</code>, et non pas de type <code>Dog</code> ou <code>Cat</code>.
C&rsquo;est pour cela que c&rsquo;est la fonction <code>sing</code> de <code>Animal</code> qui est appel√©e.</p><p><strong>Du coup, comment faire pour placer des animaux de type diff√©rents dans un conteneur, tout en gardant la possibilit√© d&rsquo;appeler sur les √©l√©ments les fonctions red√©finies dans les classes-filles ?</strong></p><p>Dans la fonction <code>sing_a_lot</code>, les fonctions des classes-fille √©taient correctement appel√©es, car <code>animal</code> √©tait pass√© par r√©f√©rence et non pas par copie.
Le programme pouvait donc retrouver le type √† partir duquel <code>animal</code> a √©t√© construit pour d√©terminer les fonctions √† appeler.
Il suffirait donc d&rsquo;utiliser un tableau de r√©f√©rence pour r√©gler le probl√®me.</p><p>Le souci, c&rsquo;est qu&rsquo;√©crire <code>vector&lt;Animal&></code> ne compilera pas.
En effet, d&rsquo;apr√®s la documentation de <code>vector</code>, le type des √©l√©ments doit √™tre assignable par copie.
Or, les r√©f√©rences ne sont pas r√©assignables&mldr;</p><p>Du coup, √† d√©faut de pouvoir utiliser des r√©f√©rences, <strong>vous allez devoir passer par des pointeurs</strong>.<br>Modifiez votre code pour de mani√®re √† remplacer le <code>vector&lt;Animal></code> par un <code>vector&lt;Animal*></code> et v√©rifiez que le programme fonctionne maintenant comme il faut.</p><div class=expand><input type=checkbox id=R-expand-0d4da9886b02cca3b0a93fb721a08c44 aria-controls=R-expandcontent-0d4da9886b02cca3b0a93fb721a08c44>
<label class=expand-label for=R-expand-0d4da9886b02cca3b0a93fb721a08c44><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-0d4da9886b02cca3b0a93fb721a08c44 class=expand-content><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sing_chorus</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>*&gt;&amp;</span> <span class=n>animals</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>*</span> <span class=nl>animal</span><span class=p>:</span> <span class=n>animals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>animal</span><span class=o>-&gt;</span><span class=n>sing</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>*&gt;</span> <span class=n>animals</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sing_chorus</span><span class=p>(</span><span class=n>animals</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><hr><h3 id=destructeurs-virtuels>Destructeurs virtuels</h3><p>Vous allez maintenant cr√©er une nouvelle classe <code>Opera</code>, contenant un tableau d&rsquo;animaux.
Contrairement √† tout √† l&rsquo;heure, ce tableau sera propri√©taire de la m√©moire des animaux qu&rsquo;il contient.</p><p>Pour faire cela, plut√¥t qu&rsquo;ins√©rer dans le tableau des pointeurs sur des objets d√©j√† existants, vous allez cr√©er et placer des <code>unique_ptr</code> dans le tableau :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;&gt;</span> <span class=n>animals</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Dog</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=n>animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Chicken</span><span class=o>&gt;</span><span class=p>());</span></span></span></code></pre></div><p>D√©finissez la classe <code>Opera</code> en respectant les contraintes suivantes :<br>- une fois le constructeur appel√©, les instances de <code>Opera</code> doivent contenir un animal de chaque type,<br>- il est possible d&rsquo;appeler une fonction <code>sing</code> sur une instance, qui ex√©cute alors la fonction <code>sing</code> de chacun des animaux qu&rsquo;elle contient.</p><p>Instanciez et utiliser cette classe dans le <code>main</code> pour v√©rifier que tout fonctionne.</p><div class=expand><input type=checkbox id=R-expand-eb1723d431c5f880837dc0c5c643323e aria-controls=R-expandcontent-eb1723d431c5f880837dc0c5c643323e>
<label class=expand-label for=R-expand-eb1723d431c5f880837dc0c5c643323e><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-eb1723d431c5f880837dc0c5c643323e class=expand-content><p>Opera.h</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#pragma once
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Animal.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Cat.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Chicken.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Cow.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Dog.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;memory&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Opera</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Opera</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Cat</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>_animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Chicken</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>_animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Cow</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>_animals</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Dog</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>sing</span><span class=p>()</span> <span class=k>const</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>animal</span><span class=p>:</span> <span class=n>_animals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>animal</span><span class=o>-&gt;</span><span class=n>sing</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;&gt;</span> <span class=n>_animals</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>FarmHouse.cpp</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Opera</span> <span class=n>opera</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>opera</span><span class=p>.</span><span class=n>sing</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Avertissement</div><div class=box-content><p>Je m&rsquo;excuse par avance pour les √¢mes sensibles.</p></div></div><p>Il para√Æt que lorsqu&rsquo;on coupe la t√™te d&rsquo;une poule, celle-ci continue de courir.
Comme ici, nous avons affaire √† des artistes et non pas des athl√®tes, nous allons dire qu&rsquo;elle continue de chanter.</p><p>Ajoutez un destructeur √† la classe <code>Chicken</code>, dans lequel vous afficherez le r√¢le d&rsquo;agonie de votre poulet. Un truc du style <code>"CotCooooooooot!"</code> fera parfaitement l&rsquo;affaire.<br>Combien d&rsquo;objets de type <code>Chicken</code> avez-vous construits dans votre programme ? Obtenez-vous le nombre de <code>"CotCooooooooot!"</code> attendus ?</p><div class=expand><input type=checkbox id=R-expand-19298ac72175678d09f3f0fd46ade42e aria-controls=R-expandcontent-19298ac72175678d09f3f0fd46ade42e>
<label class=expand-label for=R-expand-19298ac72175678d09f3f0fd46ade42e><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-19298ac72175678d09f3f0fd46ade42e class=expand-content><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Chicken</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Animal</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>Chicken</span><span class=p>()</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;CotCooooooooot!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=k>override</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Cotcotcotcodet&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>Vous devriez avoir construits au moins deux objets de type <code>Chicken</code> (un dans le <code>main</code>, et un dans la classe <code>Opera</code>).
Pourtant, il semblerait que l&rsquo;un des appels au destructeur ne soit pas r√©alis√©&mldr;</p></div></div><p><strong>Pourquoi le destructeur de <code>Chicken</code> n&rsquo;est pas tout le temps appel√© ?</strong></p><p>Il y a deux mani√®res d&rsquo;appeler le destructeur d&rsquo;un objet :</p><p>1- Si l&rsquo;objet est construit sur la pile, alors, le destructeur de cet objet est appel√© une fois que l&rsquo;on sort du bloc dans lequel il a √©t√© construit.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Chicken</span> <span class=n>chicken</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// le destructeur de chicken est appel√© √† la sortie du bloc
</span></span></span></code></pre></div><p>2- En utilisant l&rsquo;instruction <code>delete</code> sur un objet allou√© avec un <code>new</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Chicken</span><span class=o>*</span> <span class=n>chicken</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Chicken</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>delete</span> <span class=n>chicken</span><span class=p>;</span> <span class=c1>// le destructeur de chicken est appel√© sur cette ligne.
</span></span></span></code></pre></div><p>Dans le cas d&rsquo;un <code>unique_ptr&lt;T></code>, il appelle <code>delete</code> sur son pointeur interne.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Chicken</span><span class=o>&gt;</span> <span class=n>chicken</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Chicken</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// le destructeur de std::unique_ptr est appel√© √† la sortie du bloc, et celui-ci appelle `delete` sur son pointeur interne, de type Chicken*.
</span></span></span></code></pre></div><p>Le probl√®me de <code>delete</code>, c&rsquo;est qu&rsquo;il regarde le type du pointeur pour d√©terminer le destructeur √† appeler.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Chicken</span><span class=o>*</span> <span class=n>chicken</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Chicken</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>delete</span> <span class=n>chicken</span><span class=p>;</span> <span class=c1>// appelle ~Chicken, car chicken est de type Chicken*
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>Animal</span><span class=o>*</span> <span class=n>dog</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Dog</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>delete</span> <span class=n>dog</span><span class=p>;</span> <span class=c1>// appelle ~Animal, car dog est de type Animal*
</span></span></span></code></pre></div><p>Le code suivant appelera par cons√©quent le destructeur de <code>Animal</code> plut√¥t que le destructeur de <code>Chicken</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;</span> <span class=n>chicken</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Chicken</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// ~Animal() est appel√© au lieu de ~Chicken()...
</span></span></span></code></pre></div><p>Or, nous avons vu au d√©but de cette page que, lorsque le programme doit appeler une fonction, il recherche une red√©finition dans les classes-filles seulement si la fonction est d√©clar√©e virtuelle dans la classe-m√®re.
Eh bien, c&rsquo;est exactement pour cela que <code>~Chicken</code> n&rsquo;est pas appel√© pendant la destruction de la classe <code>Opera</code>.</p><p>Dans la classe <code>Opera</code>, pour appeler le <code>delete</code> sur les animaux contenus dans les <code>unique_ptr</code>, le compilateur commence par regarder le prototype de <code>~Animal</code>.
Comme vous n&rsquo;avez pas d√©fini le destructeur vous-m√™me, il tombe sur le destructeur g√©n√©r√© par d√©faut.<br>L&rsquo;impl√©mentation par d√©faut du destructeur n&rsquo;√©tant pas virtuelle, le compilateur d√©termine qu&rsquo;il n&rsquo;aura pas besoin de rechercher de red√©finition dans les classe-filles au moment de l&rsquo;ex√©cution du programme.
C&rsquo;est donc <code>~Animal</code> qui est appel√© pour chacun des animaux.</p><p>Du coup, afin que le destructeur <code>~Chicken</code> soit toujours appel√© lors de la destruction d&rsquo;un objet de type <code>Chicken</code>, il faut que vous red√©finissiez explicitement le destructeur de <code>Animal</code> pour le d√©clarer virtuel.<br>N&rsquo;oubliez pas d&rsquo;ajouter le <code>override</code> sur <code>~Chicken</code>, pour indiquer au compilateur, mais surtout √† vous-m√™me, que vous √™tes en train de red√©finir un destructeur virtuel.</p><p>Testez le programme pour v√©rifier que d√©sormais, <code>~Chicken</code> est bien appel√© durant la destruction de la variable <code>opera</code>.</p><div class=expand><input type=checkbox id=R-expand-55fc00f24abfbceceb38c6e57d72a2ba aria-controls=R-expandcontent-55fc00f24abfbceceb38c6e57d72a2ba>
<label class=expand-label for=R-expand-55fc00f24abfbceceb38c6e57d72a2ba><i class="expander-icon fa-fw fas fa-chevron-down"></i>
<i class="expander-icon fa-fw fas fa-chevron-right"></i> Solution</label><div id=R-expandcontent-55fc00f24abfbceceb38c6e57d72a2ba class=expand-content><p>Animal.h:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Animal</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=o>~</span><span class=n>Animal</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;...&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>Chicken.h:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Chicken</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Animal</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>Chicken</span><span class=p>()</span> <span class=k>override</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;CotCooooooooot!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>sing</span><span class=p>(</span><span class=kt>char</span> <span class=n>next_char</span><span class=p>)</span> <span class=k>const</span> <span class=k>override</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Cotcotcotcodet&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>next_char</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div><hr><h3 id=ce-quil-faut-retenir>Ce qu&rsquo;il faut retenir</h3><ol><li>Pour pouvoir red√©finir le comportement d&rsquo;une fonction dans une classe-fille, il faut d√©clarer la fonction comme √©tant virtuelle dans la classe-m√®re.<br>Pour cela, on place le mot-clef <code>virtual</code> en d√©but de prototype.</li></ol><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Remarque</div><div class=box-content><p>D√®s lors qu&rsquo;une fonction est d√©clar√©e virtuelle dans une classe, celle-ci reste virtuelle dans les enfants, mais aussi dans les petits-enfants, arri√®re-petit-enfants, etc.<br>D&rsquo;une part, √ßa fait qu&rsquo;il n&rsquo;est pas n√©cessaire de remettre <code>virtual</code> sur le prototype de cette fonction dans les sous-classes.<br>D&rsquo;autre part, cela veut dire qu&rsquo;il n&rsquo;est pas possible de faire en sorte qu&rsquo;une fonction virtuelle redevienne non-virtuelle √† un certain niveau de la hi√©rarchie :
une fois que c&rsquo;est virtuel, c&rsquo;est virtuel √† tout jamais.</p></div></div><ol start=2><li><p>Lorsqu&rsquo;on r√©d√©finit une fonction dans une classe-fille, on place le mot-clef <code>override</code> √† la fin de son prototype.
Cela force le compilateur √† v√©rifier qu&rsquo;on est effectivement en train de red√©finir une fonction d&rsquo;une classe de base.</p></li><li><p>Lorsqu&rsquo;on fait de l&rsquo;h√©ritage &ldquo;dynamique&rdquo;, c&rsquo;est-√†-dire qu&rsquo;on a une ou plusieurs fonction virtuelle, ou bien que l&rsquo;on compte stocker des objets de type <code>Child</code> dans des pointeurs <code>Parent</code> <strong>ownant</strong> (c&rsquo;est-√ß-dire qui peuvent d√©truire l&rsquo;objet, comme <code>unique_ptr</code>), on d√©finit <strong>TOUJOURS</strong> explicitement le destructeur de <code>Parent</code> pour le rendre virtuel. <strong>TOUJOURS !</strong></p></li><li><p>Si vous copiez un objet <code>Child</code> dans une variable <code>parent</code> de type <code>Parent</code>, vous ne pourrez pas appeler les red√©finitions de fonctions d√©finies dans <code>Child</code>.<br>Si vous souhaitez appeler des fonctions red√©finie dans une classe-fille, il faut donc que la variable soit un objet de type <code>Child</code>, ou bien qu&rsquo;elle r√©f√©rence (via une r√©f√©rence ou un pointeur) un objet de type <code>Child</code>.</p></li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Child</span>                   <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Child</span><span class=o>&amp;</span>                  <span class=n>ref</span> <span class=o>=</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Parent</span><span class=o>&amp;</span>                 <span class=n>p</span>   <span class=o>=</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Parent</span><span class=o>*</span>                 <span class=n>p</span>   <span class=o>=</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Parent</span><span class=o>&gt;</span> <span class=n>p</span>   <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Child</span><span class=o>&gt;</span><span class=p>();</span></span></span></code></pre></div><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class="default-animation showVisitedLinks"><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><a id=logo href=../../>üéÑ C++ üéÑ</a></div></div><div id=R-homelinks class=default-animation><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/chapter0/index.html><a class=padding href=../../chapter0/index.html><b>0- </b>Mise en place<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-bb41caf94f12b8a1a4b5e560230e7851 class=collapsible-menu></ul></li><li data-nav-id=/chapter1/index.html><a class=padding href=../../chapter1/index.html><b>1- </b>Introduction au C++<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-6c398714eae4372920aec3a1e6c2e143 class=collapsible-menu></ul></li><li data-nav-id=/chapter2/index.html><a class=padding href=../../chapter2/index.html><b>2- </b>Classes<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-b1df0095a9fd74320697a6d478418ec3 class=collapsible-menu></ul></li><li data-nav-id=/chapter3/index.html><a class=padding href=../../chapter3/index.html><b>3- </b>Cycle de vie<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-9f6546bce6f8e9a77063b71c880fd5b8 class=collapsible-menu></ul></li><li class=parent data-nav-id=/chapter4/index.html><a class=padding href=../../chapter4/index.html><b>4- </b>H√©ritage<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-48065e8b6e7e69533ca73b3931c8a0a1 class=collapsible-menu><li data-nav-id=/chapter4/1-hierarchy/index.html><a class=padding href=../../chapter4/1-hierarchy/index.html>üíº Hi√©rarchie professionnelle<i class="fa-fw fas fa-check read-icon"></i></a></li><li class=active data-nav-id=/chapter4/2-farm/index.html><a class=padding href=../../chapter4/2-farm/index.html>üêÆ Concerto animalier<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-id=/chapter4/3-virtual/index.html><a class=padding href=../../chapter4/3-virtual/index.html>R√©solution d'appel virtuel<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-id=/chapter4/4-polymorphism/index.html><a class=padding href=../../chapter4/4-polymorphism/index.html>Polymorphisme<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-id=/chapter4/5-vehicles/index.html><a class=padding href=../../chapter4/5-vehicles/index.html>üöó V√©hicule partag√©<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-id=/chapter4/test/index.html><a class=padding href=../../chapter4/test/index.html>Questionnaire !<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-id=/chapter4/summary/index.html><a class=padding href=../../chapter4/summary/index.html>Synth√®se<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/chapter5/index.html><a class=padding href=../../chapter5/index.html><b>5- </b>Librairie standard<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-86528e6ba587b53932a1dafaa9cd375c class=collapsible-menu></ul></li><li data-nav-id=/chapter6/index.html><a class=padding href=../../chapter6/index.html><b>6- </b>Algorithmes<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-016ee40825ff7c4aeecbac08a8ca264b class=collapsible-menu></ul></li><li data-nav-id=/chapter9/index.html><a class=padding href=../../chapter9/index.html><b>7- </b>Templates<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-24ddf636ccd0ce3ef39c8060d1779332 class=collapsible-menu></ul></li><li data-nav-id=/chapter10/index.html><a class=padding href=../../chapter10/index.html><b>8- </b>Param√®tres de templates<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-66e6e0c58d73995ecc09e8fbbe358e51 class=collapsible-menu></ul></li></ul></div><div id=R-shortcuts><div class="nav-title padding">Acc√®s rapide</div><ul class=space><li><a class=padding href=https://github.com/Laefy/CPP_Learning_Code/><i class='fab fa-github'></i> D√©p√¥t Cours</a></li><li><a class=padding href=https://github.com/Laefy/CPP_Exercises/><i class='fab fa-github'></i> D√©p√¥t TPs</a></li><li><a class=padding href=../../slides/index.html><i class='far fa-file-powerpoint'></i> Slides</a></li><li><a class=padding href=../../workflow/index.html><i class='far fa-list-alt'></i> Workflow</a></li><li><a class=padding href=../../faq/index.html><i class='fas fa-question-circle'></i> FAQ</a></li><li><a class=padding href=../../chapter0/6-tips/index.html><i class='fa fa-rocket'></i> Astuces</a></li><li><a class=padding href=https://godbolt.org/><i class='fas fa-cog'></i> Compiler Explorer</a></li><li><a class=padding href=https://en.cppreference.com/w/><i class='fas fa-passport'></i> CPP-Ref</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVisitedLinks showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVisitedLinks showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks showVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fa-fw fas fa-language"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Langue</label>
<select id=R-select-language onchange="location=this.querySelector(this.value).dataset.url"><option id=R-select-language-fr value=#R-select-language-fr data-url=../../chapter4/2-farm/index.html lang=fr selected>Fran√ßais</option></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Th√®me</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-select-variant-mine value=mine selected>Mine</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class="footerVisitedLinks showVisitedLinks"><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Supprimer l'historique</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></div></aside><script src=../../js/clipboard.min.js?1729268528 defer></script><script src=../../js/perfect-scrollbar.min.js?1729268528 defer></script><script src=../../js/theme.js?1729268528 defer></script><button id=footer-question-btn title="Envoyer un message √† propos du texte s√©lectionn√©" onclick=openQuestionForm() disabled><i class="fas fa-question-circle"></i></button><div id=footer-question-window disabled><form id=question method=POST action=https://formsubmit.co/3aa0f379a1aed9c454634cc2da153a7b target=question-submitted onsubmit=cleanQuestionFormContent()><input type=email name=email placeholder=mon_email@smthg.com required onchange=updateQuestionFormSubject()>
<textarea name=question rows=7 cols=30 placeholder="Mon message..."></textarea>
<input type=hidden name=selection>
<input type=hidden name=_replyto>
<input type=hidden name=_subject>
<input type=hidden name=_template value=box>
<input type=hidden name=_captcha value=false>
<input type=hidden name=_next value=//question-submitted/>
<input type=submit disabled style=display:none aria-hidden=true>
<input type=submit value=Envoyer></form><iframe class=hidden name=question-submitted src></iframe></div><script>function updateQuestionFormSubject(){let e=document.querySelector('#question>input[name="email"]').value;document.querySelector('#question>input[name="_subject"]').value="[C++][Chapitre 4] "+e+", retour sur ta question"}function cleanQuestionFormContent(){function e(e){e.value=e.value.replace(/\[\.\./g,"[ ..")}e(document.querySelector('#question>textarea[name="question"]')),e(document.querySelector('#question>input[name="selection"]'))}function openQuestionForm(){document.getElementById("footer-question-window").removeAttribute("disabled");var e=window.getSelection().toString();document.querySelector('#question>input[name="selection"]').value=e}function updateQuestionWidgetState(e){var t=document.getElementById("R-body-inner"),n=window.getSelection(),s=document.getElementById("footer-question-window");document.getElementById("footer-question-btn").disabled=n.isCollapsed||t==null||t.contains(n.anchorNode)==!1||t.contains(n.focusNode)==!1,e!==void 0&&e.type=="mouseup"&&s.contains(e.target)==!1&&s.contains(document.activeElement)==!1&&s.setAttribute("disabled",!0)}updateQuestionFormSubject(),document.onmouseup=document.onkeyup=document.onselectionchange=updateQuestionWidgetState,updateQuestionWidgetState()</script></body></html>